<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Factory Frenzy: Job Rewards</title>
    <style>
        canvas {
            border: 1px solid #000;
            background-color: #f8f8f8;
        }
        #gameInfo {
            margin-top: 20px;
            font-family: Arial, sans-serif;
        }
        .job-spot {
            font-weight: bold;
            margin-right: 10px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
</head>
<body>

<canvas id="factoryCanvas" width="800" height="800"></canvas>

<div id="gameInfo"></div>

<script>
    const canvas = document.getElementById('factoryCanvas');
    const ctx = canvas.getContext('2d');
    const gridSize = 5;  // Fixed 5x5 grid
    const cellSize = canvas.width / gridSize;

    // Contract ABI (replace with the ABI of your deployed contract)
    const contractABI =  [
            {
                "inputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "_rewardToken",
                        "type": "address"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "owner",
                        "type": "address"
                    }
                ],
                "name": "OwnableInvalidOwner",
                "type": "error"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "account",
                        "type": "address"
                    }
                ],
                "name": "OwnableUnauthorizedAccount",
                "type": "error"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "collector",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "string",
                        "name": "jobSpotId",
                        "type": "string"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "reward",
                        "type": "uint256"
                    }
                ],
                "name": "JobCollected",
                "type": "event"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "previousOwner",
                        "type": "address"
                    },
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "OwnershipTransferred",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "jobSpotId",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "jobSpotUUID",
                        "type": "string"
                    }
                ],
                "name": "collectJob",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "depositTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getAllJobSpots",
                "outputs": [
                    {
                        "internalType": "string[]",
                        "name": "",
                        "type": "string[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "jobSpotId",
                        "type": "string"
                    }
                ],
                "name": "getJobReward",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "gridSize",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "initialize",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "jobSpotIds",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "",
                        "type": "string"
                    }
                ],
                "name": "jobSpots",
                "outputs": [
                    {
                        "internalType": "string",
                        "name": "UUID",
                        "type": "string"
                    },
                    {
                        "internalType": "uint256",
                        "name": "reward",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "collector",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "renounceOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "rewardToken",
                "outputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string[]",
                        "name": "uuids",
                        "type": "string[]"
                    }
                ],
                "name": "setAllJobSpotUUIDs",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "string",
                        "name": "jobSpotId",
                        "type": "string"
                    },
                    {
                        "internalType": "string",
                        "name": "jobSpotUUID",
                        "type": "string"
                    }
                ],
                "name": "setJobSpotUUID",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalRewards",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "totalReward",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "withdrawTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

    // Contract address (replace with the actual deployed contract address)
    const contractAddress = '0x5fbdb2315678afecb367f032d93f642f64180aa3';

    // Web3 instance to connect to local Ethereum node (replace with your node URL if necessary)
    const web3 = new Web3('http://localhost:8545');

    // Connect to the deployed contract
    const contract = new web3.eth.Contract(contractABI, contractAddress);

    // Web3 connection check
    async function checkWeb3Connection() {
        try {
            const isConnected = await web3.eth.net.isListening();
            if (isConnected) {
                console.log('Web3 is successfully connected to the local node.');
            } else {
                console.error('Web3 is not connected.');
            }

            const accounts = await web3.eth.getAccounts();
            if (accounts.length > 0) {
                console.log(`Connected accounts: ${accounts}`);
            } else {
                console.error('No accounts found.');
            }

        } catch (error) {
            console.error('Error connecting to Web3:', error);
        }
    }

    // Function to draw the factory grid
    function drawGrid() {
        ctx.strokeStyle = '#ccc';
        for (let i = 0; i <= gridSize; i++) {
            ctx.beginPath();
            ctx.moveTo(i * cellSize, 0);
            ctx.lineTo(i * cellSize, canvas.height);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(0, i * cellSize);
            ctx.lineTo(canvas.width, i * cellSize);
            ctx.stroke();
        }
    }

    // Function to draw job spots with rewards
    async function drawJobSpots() {
        const jobSpots = await contract.methods.getAllJobSpots().call(); // Get all job spot IDs from contract

        for (let i = 0; i < jobSpots.length; i++) {
            const jobSpotId = jobSpots[i];
            const jobSpotData = await contract.methods.jobSpots(jobSpotId).call(); // Fetch job spot data
            const reward = await contract.methods.getJobReward(jobSpotId).call(); // Fetch reward amount
            drawJobSpot(jobSpotId, reward, jobSpotData.collector);
        }
    }

    // Function to draw a specific job spot on the grid
    function drawJobSpot(jobSpotId, reward, collector) {
        const rowIndex = jobSpotId.charCodeAt(0) - 65; // Convert 'A' to 0, 'B' to 1, etc.
        const colIndex = parseInt(jobSpotId[1]) - 1;

        const x = colIndex * cellSize + cellSize / 2;
        const y = rowIndex * cellSize + cellSize / 2;

        // Color the job spot based on collector
        if (!collector || collector === '0x0000000000000000000000000000000000000000') {
            ctx.fillStyle = '#a2a1a1'; // Gray if uncollected
        } else {
            ctx.fillStyle = 'green'; // Green if collected
        }

        ctx.beginPath();
        ctx.arc(x, y, 30, 0, 2 * Math.PI);
        ctx.fill();
        ctx.strokeStyle = '#000';
        ctx.stroke();

        // Draw the reward amount (formatted to 2 decimals for better readability)
        const formattedReward = (parseInt(reward) / 10 ** 18).toFixed(0);
        ctx.fillStyle = '#000';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(`${formattedReward}`, x, y+2);
    }

    // Draw the initial grid and fetch job data
    async function initialize() {
        await checkWeb3Connection();
        drawGrid(); // Draw the factory grid
        drawJobSpots(); // Fetch and draw job spots with rewards data
    }

    // Initialize the page
    initialize();
</script>

</body>
</html>
