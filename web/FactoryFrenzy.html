<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Factory Frenzy: Job Rewards</title>
    <style>
        canvas {
            border: 1px solid #000;
            background-color: #f8f8f8;
        }
        #gameInfo {
            margin-top: 20px;
            font-family: Arial, sans-serif;
        }
        .job-spot {
            font-weight: bold;
            margin-right: 10px;
        }
        #scores {
            margin-top: 20px;
            font-family: Arial, sans-serif;
            font-size: 16px;
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/web3/dist/web3.min.js"></script>
</head>
<body>

<canvas id="factoryCanvas" width="800" height="800"></canvas>

<div id="gameInfo"></div>
<div id="scores">Scores: <div id="playerScores"></div></div>

<script>
    const canvas = document.getElementById('factoryCanvas');
    const ctx = canvas.getContext('2d');
    const gridSize = 5;  // Fixed 5x5 grid
    const cellSize = canvas.width / gridSize;

    // Contract ABI (replace with the ABI of your deployed contract)
    const contractABI =  [
            {
                "inputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "_rewardToken",
                        "type": "address"
                    }
                ],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "anonymous": false,
                "inputs": [
                    {
                        "indexed": true,
                        "internalType": "address",
                        "name": "collector",
                        "type": "address"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint8",
                        "name": "jobSpotId",
                        "type": "uint8"
                    },
                    {
                        "indexed": false,
                        "internalType": "uint256",
                        "name": "reward",
                        "type": "uint256"
                    }
                ],
                "name": "JobCollected",
                "type": "event"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "jobSpotId",
                        "type": "uint8"
                    }
                ],
                "name": "collectJob",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "depositTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "getAllJobSpots",
                "outputs": [
                    {
                        "internalType": "uint8[]",
                        "name": "",
                        "type": "uint8[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "jobSpotId",
                        "type": "uint8"
                    }
                ],
                "name": "getJobReward",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "size",
                        "type": "uint8"
                    }
                ],
                "name": "initialize",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "",
                        "type": "uint256"
                    }
                ],
                "name": "jobSpotIds",
                "outputs": [
                    {
                        "internalType": "uint8",
                        "name": "",
                        "type": "uint8"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint8",
                        "name": "",
                        "type": "uint8"
                    }
                ],
                "name": "jobSpots",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "reward",
                        "type": "uint256"
                    },
                    {
                        "internalType": "address",
                        "name": "collector",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "rewardToken",
                "outputs": [
                    {
                        "internalType": "contract IERC20",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "totalRewards",
                "outputs": [
                    {
                        "internalType": "uint256",
                        "name": "totalReward",
                        "type": "uint256"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "withdrawTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            }
        ];

    // Contract address (replace with the actual deployed contract address)
    const contractAddress = '0xf745EA20b7dC2c63BC493B9E14539Fdf10d9e43A';

    // Web3 instance to connect to local Ethereum node (replace with your node URL if necessary)
    const web3 = new Web3('https://rpc-amoy.polygon.technology/');

    // Connect to the deployed contract
    const contract = new web3.eth.Contract(contractABI, contractAddress);

    // Web3 connection check
    async function checkWeb3Connection() {
        try {
            const isConnected = await web3.eth.net.isListening();
            if (isConnected) {
                console.log('Web3 is successfully connected to the local node.');
            } else {
                console.error('Web3 is not connected.');
            }

        } catch (error) {
            console.error('Error connecting to Web3:', error);
        }
    }

    // Function to draw the factory grid
    function drawGrid() {
        ctx.strokeStyle = '#ccc';
        for (let i = 0; i <= gridSize; i++) {
            ctx.beginPath();
            ctx.moveTo(i * cellSize, 0);
            ctx.lineTo(i * cellSize, canvas.height);
            ctx.stroke();

            ctx.beginPath();
            ctx.moveTo(0, i * cellSize);
            ctx.lineTo(canvas.width, i * cellSize);
            ctx.stroke();
        }
    }

    // Function to draw job spots with rewards and update player scores
    async function drawJobSpots() {
        const jobSpots = await contract.methods.getAllJobSpots().call(); // Get all job spot IDs from contract
        playerScores = {};  // Reset player scores before calculating them

        const promises = jobSpots.map(async (jobSpotId) => {
            const jobSpotData = await contract.methods.jobSpots(jobSpotId).call(); // Fetch job spot data
            // const reward = await contract.methods.getJobReward(jobSpotId).call(); // Fetch reward amount
            drawJobSpot(parseInt(jobSpotId), parseInt(jobSpotData.reward) , jobSpotData.collector);

            if (jobSpotData.collector && jobSpotData.collector !== '0x0000000000000000000000000000000000000000') {
                if (!playerScores[jobSpotData.collector]) {
                    playerScores[jobSpotData.collector] = {
                        jobsCollected: 1,
                        totalReward: parseInt(jobSpotData.reward)
                    };
                } else {
                    playerScores[jobSpotData.collector].jobsCollected++;
                    playerScores[jobSpotData.collector].totalReward += parseInt(jobSpotData.reward);
                }
            }
        });

        await Promise.all(promises);
        updatePlayerScores();
    }


    // Function to convert an address into a hex color
    function addressToColor(address) {
        // Take the last 6 characters of the address and prepend '#' to make a hex color
        return `#${address.slice(-6)}`;
    }

    // Function to draw a specific job spot on the grid
    function drawJobSpot(jobSpotId, reward, collector) {
        const rowIndex = Math.floor(jobSpotId / gridSize); // Row index
        const colIndex = jobSpotId % gridSize; // Column index

        const x = colIndex * cellSize + cellSize / 2;
        const y = rowIndex * cellSize + cellSize / 2;

        // Color the job spot based on collector
        if (!collector || collector === '0x0000000000000000000000000000000000000000') {
            ctx.fillStyle = '#a2a1a1'; // Gray if uncollected
        } else {
            // Generate color based on the collector's address
            ctx.fillStyle = addressToColor(collector);
        }

        ctx.beginPath();
        ctx.arc(x, y, 30, 0, 2 * Math.PI);
        ctx.fill();
        ctx.strokeStyle = '#000';
        ctx.stroke();

        // Draw the reward amount (formatted to 2 decimals for better readability)
        const formattedReward = (parseInt(reward) / 10 ** 18).toFixed(0);
        ctx.fillStyle = '#000';
        ctx.font = '16px Arial';
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(`${formattedReward}`, x, y+2);

        //Draw small text with job spot ID
        ctx.font = '16px Arial';
        ctx.fillText(`${jobSpotId}`, x, y-45);

    }

    // Function to update and display the player scores
    function updatePlayerScores() {
        const playerScoresDiv = document.getElementById('playerScores');
        playerScoresDiv.innerHTML = '';  // Clear existing scores

        Object.keys(playerScores).forEach((player) => {
            const scoreEntry = document.createElement('div');
            scoreEntry.style.color = addressToColor(player);  // Color each player's score with their unique color
            const formattedReward = (playerScores[player].totalReward / 10 ** 18).toFixed(0);  // Convert to Ether-like format
            scoreEntry.textContent = `${player.slice(0, 6)}...: ${playerScores[player].jobsCollected} jobs collected, Total Reward: ${formattedReward} tokens`;
            playerScoresDiv.appendChild(scoreEntry);
        });
    }


    // Draw the initial grid and fetch job data
    async function initialize() {
        await checkWeb3Connection();
        drawGrid(); // Draw the factory grid
        drawJobSpots(); // Fetch and draw job spots with rewards data
    }

    // Initialize the page
    initialize();
</script>

</body>
</html>